<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>勇者侵入テスト</title>
  <link rel="stylesheet" href="../styles/styles.css" />
</head>
<body>
  <header>
    <h1>勇者侵入</h1>
  </header>
  <main>
    <div class="control-panel">
      <button id="nextTurn">次のターン</button>
      <span id="status"></span>
    </div>
    <div id="concept"></div>
    <div id="quote"></div>
    <canvas id="mapCanvas"></canvas>
  </main>
  <script type="module">
    import { generateMap } from '../lib/resourceManager.js';
    import { HeroAI } from '../scripts/hero_ai.js';
    import { MapRenderer } from '../scripts/map_renderer.js';
    import { TurnManager } from '../scripts/turn_manager.js';
    import config from '../data/game_config.json' assert { type: 'json' };
    import mapInfo from '../data/map.json' assert { type: 'json' };
    import heroParties from '../data/hero_parties.json' assert { type: 'json' };

    const map = generateMap(
      config.gridWidth,
      config.gridHeight,
      mapInfo.defaultTile
    );
    const renderer = new MapRenderer(document.getElementById('mapCanvas'), map);
    const tm = new TurnManager(config.stageCount, config.wavesPerStage);

    let heroes = [];

    function startWave() {
      const party = heroParties[tm.getWaveIndex()];
      heroes = party ? party.members.map(() => new HeroAI(0, 0)) : [];
      document.getElementById('concept').textContent =
        party ? `コンセプト: ${party.concept}` : '';
      document.getElementById('quote').textContent =
        party ? `出発セリフ: ${party.departure_quote}` : '';
    }

    function updateStatus() {
      const party = heroParties[tm.getWaveIndex()];
      const team = party ? party.team : '---';
      document.getElementById('status').textContent =
        `Stage ${tm.currentStage} Wave ${tm.currentWave} (${team}) - Phase: ${tm.phase}`;
    }

    function nextTurn() {
      if (tm.isFinished()) return;

      if (tm.phase === 'prepare') {
        startWave();
      } else {
        heroes.forEach(h => h.getNextMove(map));
      }

      tm.nextPhase();
      renderer.render(heroes);
      updateStatus();
    }

    document.getElementById('nextTurn').addEventListener('click', nextTurn);
    renderer.render();
    updateStatus();
  </script>
</body>
</html>

